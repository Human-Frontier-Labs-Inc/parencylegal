# Database Migrations

## Generated Migrations

### 0000_white_triathlon.sql
**Created:** Auto-generated by Drizzle Kit
**Contains:**
- 8 tables (profiles, cases, documents, discovery_requests, document_request_mappings, ai_chat_sessions, sync_history, dropbox_connections)
- 1 enum type (membership)
- 6 foreign key constraints
- 20+ indexes for performance
- All column definitions with defaults

**Tables Created:**
1. `profiles` - 21 columns
2. `cases` - 13 columns, 2 indexes
3. `documents` - 24 columns, 5 indexes, 1 FK
4. `discovery_requests` - 12 columns, 4 indexes, 1 FK
5. `document_request_mappings` - 13 columns, 5 indexes, 2 FKs
6. `ai_chat_sessions` - 14 columns, 4 indexes, 1 FK
7. `sync_history` - 15 columns, 4 indexes, 1 FK
8. `dropbox_connections` - 12 columns, 2 indexes

---

### 0001_rls_policies.sql
**Created:** Manually for RLS policies
**Contains:**
- Row Level Security enabled on all 8 tables
- 40 RLS policies (5 per table)
- Service role pattern for all writes
- User-level read access only

**Security Model:**
- Users can only SELECT their own data (via `user_id`)
- All INSERT/UPDATE/DELETE requires `service_role`
- Prevents malicious client-side data manipulation

---

## How to Apply Migrations

### Option 1: Use Drizzle Push (Recommended for Development)
```bash
npm run db:push
```
This will:
- Push schema directly to Supabase
- No migration files tracking needed
- Fast and easy for development

### Option 2: Manual Migration via Supabase Dashboard
1. Go to Supabase Dashboard → SQL Editor
2. Copy contents of `0000_white_triathlon.sql`
3. Run the SQL
4. Copy contents of `0001_rls_policies.sql`
5. Run the SQL
6. Verify tables created in Table Editor

### Option 3: Use Drizzle Migrate (Production)
```bash
npm run db:migrate
```
This will:
- Apply migrations in order
- Track migration history
- Safe for production

---

## Verification

### Check Tables Created
```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
AND table_type = 'BASE TABLE';
```

### Check RLS Enabled
```sql
SELECT tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public';
```

### Check Indexes
```sql
SELECT indexname, tablename
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename;
```

### Check Foreign Keys
```sql
SELECT
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints AS tc
JOIN information_schema.key_column_usage AS kcu
    ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
    ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY';
```

---

## After Migration

### View Schema in Drizzle Studio
```bash
npm run db:studio
```
Opens web UI at http://localhost:4983

### Seed Test Data
Run seed script (to be created):
```bash
npm run db:seed
```

---

## Rollback (if needed)

### Drop All Tables
```sql
DROP TABLE IF EXISTS document_request_mappings CASCADE;
DROP TABLE IF EXISTS sync_history CASCADE;
DROP TABLE IF EXISTS ai_chat_sessions CASCADE;
DROP TABLE IF EXISTS discovery_requests CASCADE;
DROP TABLE IF EXISTS documents CASCADE;
DROP TABLE IF EXISTS cases CASCADE;
DROP TABLE IF EXISTS dropbox_connections CASCADE;
DROP TABLE IF EXISTS profiles CASCADE;
DROP TYPE IF EXISTS membership;
```

**⚠️ WARNING:** This will delete all data!

---

## Migration Status

- [x] Schema designed
- [x] Migrations generated
- [x] RLS policies created
- [ ] Migrations applied to Supabase
- [ ] Schema verified in Drizzle Studio
- [ ] Seed data created
- [ ] Tests written

---

**Next Step:** Run `npm run db:push` to apply migrations to Supabase.
